{% load i18n %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}RMA Network GIS{% endblock %}</title>

  <!-- Preload Inter font -->
  <link rel="preload"
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
        as="style">
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
        rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
        rel="stylesheet">

  <!-- Leaflet CSS (for map pages) -->
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">

  <!-- Your global stylesheet (where you also keep the CSS variables, etc.) -->
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="icon" href="{% static 'assets/rma_sig_logo.png' %}" type="image/png">

  {% block head %}{% endblock %}

  <style>
    /* -------------------------------------------------------------------
       (A) Force sidebar ABOVE the fixed navbar
       ------------------------------------------------------------------- */
    .sidebar {
      z-index: 1100;  /* must be > nav’s z-index (nav is 1000) */
    }

    /* -------------------------------------------------------------------
       (B) Responsive toggle for nav‐links vs. hamburger
       ------------------------------------------------------------------- */
    .desktop-only {
      display: flex;
    }
    .mobile-only {
      display: none;
    }

    /* Breakpoint: hide desktop links, show hamburger on ≤ 992px */
    @media (max-width: 992px) {
      .desktop-only {
        display: none !important;
      }
      .mobile-only {
        display: flex !important;
      }
    }

    /* -------------------------------------------------------------------
       (C) Overlay for the sidebar (semi-transparent dark) 
       ------------------------------------------------------------------- */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1090;  /* slightly below the sidebar (1100) but above main content */
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .overlay.show {
      opacity: 1;
      visibility: visible;
    }

    /* -------------------------------------------------------------------
       (D) Basic navbar styling (fixed at top)
       ------------------------------------------------------------------- */
    nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 80px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px) saturate(180%);
      border-bottom: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      z-index: 1000;
      transition: var(--transition);
    }
    nav:hover {
      box-shadow: var(--shadow-md);
    }
    nav ul {
      width: 100%;
      height: 100%;
      list-style: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 2rem;
      max-width: 1400px;
      margin: 0 auto;
    }
    nav li:first-child {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    nav .logo {
      height: 40px;
      width: auto;
      transition: var(--transition);
    }
    nav .logo:hover {
      transform: scale(1.05);
    }

    /* -------------------------------------------------------------------
       (E) Styling for links inside nav
       ------------------------------------------------------------------- */
    nav a {
      text-decoration: none;
      color: var(--text-primary);
      font-weight: 500;
      padding: 0.75rem 1.5rem;
      border-radius: var(--border-radius);
      transition: var(--transition);
      position: relative; /* for the hover-shimmer effect */
      overflow: hidden;
      display: flex;
      align-items: center;
    }
    nav a:hover {
      background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      color: white;
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    nav a::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }
    nav a:hover::before {
      left: 100%;
    }

    /* -------------------------------------------------------------------
       (F) Sidebar (mobile drawer)
       ------------------------------------------------------------------- */
    .sidebar {
      position: fixed;
      top: 0;
      right: -300px; /* hide off-screen initially */
      height: 100vh;
      width: 300px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px) saturate(180%);
      box-shadow: var(--shadow-lg);
      list-style: none;
      display: flex;
      flex-direction: column;
      padding: 2rem 0;
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border-left: 1px solid var(--border-color);
    }
    .sidebar.show {
      right: 0;
    }
    .sidebar .close-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: var(--bg-tertiary);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
    }
    .sidebar .close-btn:hover {
      background: var(--danger-color);
      color: white;
      transform: rotate(90deg);
    }
    .sidebar li {
      width: 100%;
      margin: 0.25rem 0;
    }
    .sidebar a {
      width: 100%;
      padding: 1rem 2rem;
      border-radius: 0;
      margin: 0;
      border-left: 4px solid transparent;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: var(--text-primary);
      text-decoration: none;
    }
    .sidebar a:hover {
      background: var(--bg-secondary);
      border-left-color: var(--primary-color);
      transform: translateX(8px);
    }

    /* -------------------------------------------------------------------
       (G) Mobile “hamburger” button
       ------------------------------------------------------------------- */
    .menu-button {
      display: none; /* hidden on desktop */
      background: var(--bg-tertiary);
      border: none;
      width: 48px;
      height: 48px;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }
    .menu-button:hover {
      background: var(--primary-color);
      color: white;
      transform: scale(1.05);
    }
    .menu-button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.3s, height 0.3s;
    }
    .menu-button:active::before {
      width: 100px;
      height: 100px;
    }

    /* -------------------------------------------------------------------
       (H) Main content area should start _below_ the 80px navbar
       ------------------------------------------------------------------- */
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      color: var(--text-primary);
      line-height: 1.6;
      padding-top: 80px; /* so main content is never hidden behind fixed navbar */
    }
    main {
      min-height: calc(100vh - 80px);
      padding: 2rem;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* -------------------------------------------------------------------
       (I) Small screens: show hamburger, hide desktop links
       ------------------------------------------------------------------- */
    @media (max-width: 992px) {
      main {
        padding: 1rem;
      }
      .hideOnMobile {
        display: none; /* in case you still have hideOnMobile elsewhere */
      }
      .menu-button {
        display: flex; /* show hamburger */
        align-items: center;
        justify-content: center;
      }
      nav ul {
        padding: 0 1rem;
      }
      .logo {
        height: 32px !important;
      }
    }
  </style>
</head>

<body>
  <!-- Overlay for mobile sidebar -->
  <div class="overlay" id="overlay" onclick="hideSidebar()"></div>

  <!-- ==================== NAVBAR ==================== -->
  <nav>
    <ul>
      <!-- (1) Logo on the far left -->
      <li>
        <a href="{% url 'home' %}" class="d-inline-block">
          <img src="{% static 'assets/rma_sig_logo.png' %}"
               alt="RMA SIG"
               class="logo">
          <span class="d-none d-md-inline fw-semibold">RMA Network</span>
        </a>
      </li>

      <!-- (2) This <li> holds ALL of your "home / map / notifications / logout" links
            and will be pushed to the far right via margin-left: auto ) -->
      <li class="nav-links desktop-only">
        <a href="{% url 'home' %}">
          <i class="bi bi-house me-1"></i> {% trans "home" %}
        </a>
        <a href="{% url 'frontend:map' %}">
          <i class="bi bi-geo-alt me-1"></i> {% trans "map" %}
        </a>
        {% if user.is_authenticated %}
          {% include "partials/_notif_dropdown.html" %}
          <a href="{% url 'logout' %}">
            <i class="bi bi-box-arrow-right me-1"></i> {% trans "logout" %}
          </a>
        {% endif %}
      </li>

      <!-- (3) On mobile (≤992px), hide the above <li> and instead show a single hamburger
            button, which also needs to be pushed to the right ) -->
      <li class="mobile-only">
        <button
          class="menu-button"
          onclick="showSidebar()"
          aria-label="Open menu"
        >
          <i class="bi bi-list fs-4"></i>
        </button>
      </li>
    </ul>
  </nav>
  <!-- ================== END NAVBAR ================== -->


  <!-- ==================== SIDEBAR (Mobile only) ==================== -->
  <ul class="sidebar" id="sidebar">
    <button class="close-btn" onclick="hideSidebar()" aria-label="Close menu">
      <i class="bi bi-x-lg"></i>
    </button>
    
    <li>
      <a href="{% url 'home' %}">
        <i class="bi bi-house me-2"></i>
        {% trans "home" %}
      </a>
    </li>
    <li>
      <a href="{% url 'frontend:map' %}">
        <i class="bi bi-geo-alt me-2"></i>
        {% trans "map" %}
      </a>
    </li>

    {% if user.is_authenticated %}
      <li>
        <a href="{% url 'logout' %}">
          <i class="bi bi-box-arrow-right me-2"></i>
          {% trans "logout" %}
        </a>
      </li>
    {% endif %}
  </ul>
  <!-- ================ END SIDEBAR ==================== -->


  <!-- ==================== MAIN CONTENT ==================== -->
  <main>
    {% block content %}{% endblock %}
  </main>
  <!-- ================== END MAIN CONTENT ==================== -->


  <!-- ==================== SCRIPTS ==================== -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // Function to slide sidebar into view
    function showSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('overlay');
      sidebar.classList.add('show');
      overlay.classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    // Function to hide sidebar
    function hideSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('overlay');
      sidebar.classList.remove('show');
      overlay.classList.remove('show');
      document.body.style.overflow = 'auto';
    }

    // Close sidebar on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        hideSidebar();
      }
    });

    // “Mark all” and toggle notifications via AJAX
    document.addEventListener('DOMContentLoaded', () => {
      // Mark-all form
      document.querySelectorAll('.mark-all-form').forEach(form => {
        form.addEventListener('submit', e => {
          e.preventDefault();
          const button = form.querySelector('button');
          const original = button.innerHTML;
          button.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Processing...';
          button.disabled = true;

          fetch(form.action, {
            method: 'POST',
            headers: {'X-CSRFToken': csrfToken()},
          })
          .then(r => {
            if (r.ok) {
              location.reload();
            } else {
              throw new Error('Request failed');
            }
          })
          .catch(() => {
            button.innerHTML = original;
            button.disabled = false;
            showNotification('Error processing request', 'error');
          });
        });
      });

      // Toggle single notification “read/unread”
      document.querySelectorAll('.mark-toggle').forEach(cb => {
        cb.addEventListener('change', () => {
          const link = cb.closest('.dropdown-item').querySelector('a');
          const wasRead = cb.checked;
          // optimistic update
          link.classList.toggle('fw-semibold', !wasRead);

          fetch(`/notifications/toggle/${cb.dataset.id}/`, {
            method: 'POST',
            headers: {'X-CSRFToken': csrfToken()},
          })
          .then(r => r.json())
          .then(d => {
            link.classList.toggle('fw-semibold', !d.read);
          })
          .catch(() => {
            cb.checked = !cb.checked;
            link.classList.toggle('fw-semibold', wasRead);
            showNotification('Error updating notification', 'error');
          });
        });
      });

      // CSRF helper
      function csrfToken() {
        return document.cookie
                   .split('; ')
                   .find(c => c.startsWith('csrftoken='))
                   ?.split('=')[1];
      }

      // Simple toast
      function showNotification(msg, type='info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type==='error'?'danger':'info'} position-fixed`;
        alertDiv.style.cssText = 'top:100px; right:20px; z-index:9999; min-width:300px;';
        alertDiv.innerHTML = `
          ${msg}
          <button type="button" class="btn-close ms-2" onclick="this.parentElement.remove()"></button>
        `;
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 5000);
      }
    });

    // Smooth-scroll anchors
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function(e) {
        e.preventDefault();
        const tgt = document.querySelector(this.getAttribute('href'));
        if (tgt) {
          tgt.scrollIntoView({ behavior:'smooth', block:'start' });
        }
      });
    });

    // Add “loading” class to forms on submit
    document.querySelectorAll('form').forEach(f => {
      f.addEventListener('submit', () => {
        const btn = f.querySelector('button[type="submit"], input[type="submit"]');
        if (btn && !btn.disabled) {
          btn.classList.add('loading');
        }
      });
    });
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>
