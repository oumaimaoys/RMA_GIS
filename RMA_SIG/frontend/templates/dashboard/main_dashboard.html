{# dashboard.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}RMA Market Coverage Dashboard{% endblock %}
{% block head %}
  <!-- Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <!-- Font Awesome -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    rel="stylesheet"
  />

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; color: #333;
    }
    .dashboard-container {
      max-width: 1400px; margin: 0 auto; padding: 20px;
    }
    .header {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px; padding: 30px; margin-bottom: 30px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      border: 1px solid rgba(255,255,255,0.2);
    }
    .header h1 {
      font-size: 2.5rem; font-weight: 700;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }
    .header p { color: #666; font-size: 1.1rem; }

    .filters {
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
      border-radius: 15px; padding: 20px; margin-bottom: 30px;
      display: flex; gap: 20px; align-items: center; flex-wrap: wrap;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .filter-group {
      display: flex; flex-direction: column; gap: 5px;
    }
    .filter-group label {
      font-weight: 600; color: #555; font-size: 0.9rem;
    }
    .filter-group select,
    .filter-group input {
      padding: 12px 15px; border: 2px solid #e0e0e0;
      border-radius: 10px; font-size: 1rem; transition: .3s;
      background: white;
    }
    .filter-group select:focus,
    .filter-group input:focus {
      outline: none; border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
    }
    .filters button {
      padding: 12px 20px; border: none; border-radius: 10px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white; font-weight: 600; cursor: pointer;
      transition: .3s;
    }
    .filters button:hover {
      box-shadow: 0 5px 15px rgba(102,126,234,0.3);
    }

    .nav-tabs {
      display: flex; gap: 20px; margin-bottom: 30px;
      background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
      border-radius: 15px; padding: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .nav-tab {
      padding: 12px 25px; background: transparent; border: none;
      border-radius: 10px; font-weight: 600; cursor: pointer;
      transition: .3s; color: #666;
    }
    .nav-tab.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white; box-shadow: 0 5px 15px rgba(102,126,234,0.3);
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .stats-grid,
    .analysis-grid {
      display: grid;
      gap: 20px;
      margin-bottom: 30px;
    }
    .stats-grid { grid-template-columns: repeat(auto-fit, minmax(250px,1fr)); }
    .analysis-grid { grid-template-columns: repeat(auto-fit, minmax(400px,1fr)); }

    .stat-card,
    .analysis-card,
    .chart-container,
    .opportunities-list {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px; padding: 25px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      transition: .3s; position: relative; overflow: hidden;
    }
    .stat-card::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0; height: 4px;
      background: linear-gradient(135deg, #667eea, #764ba2);
    }
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 25px 50px rgba(0,0,0,0.15);
    }
    .stat-icon {
      font-size: 2.5rem; margin-bottom: 15px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .stat-value { font-size: 2.2rem; font-weight: 700; color: #333; }
    .stat-label { color: #666; font-size: .95rem; font-weight: 500; }

    .content-grid {
      display: grid; grid-template-columns: 2fr 1fr; gap: 30px;
      margin-bottom: 30px;
    }

    .opportunity-item {
      display: flex; justify-content: space-between;
      align-items: center; padding: 12px 0;
      border-bottom: 1px solid #f0f0f0; transition: .3s;
    }
    .opportunity-item:hover {
      background: rgba(102,126,234,0.05);
      border-radius: 10px; padding: 12px 15px;
    }
    .opportunity-name { font-weight: 600; color: #333; }
    .opportunity-score {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white; padding: 5px 12px; border-radius: 20px;
      font-size: .9rem; font-weight: 600;
    }

    .analysis-title {
      font-size: 1.3rem; font-weight: 600;
      margin-bottom: 20px; color: #333;
      display: flex; align-items: center; gap: 10px;
    }
    .analysis-item {
      display: flex; justify-content: space-between;
      align-items: center; padding: 10px 0;
      border-bottom: 1px solid #f5f5f5;
    }
    .analysis-item:last-child { border-bottom: none; }
    .item-name { font-weight: 500; color: #333; }
    .item-value { color: #666; font-size: .9rem; }

    .badge {
      padding: 4px 10px; border-radius: 15px;
      font-size: .8rem; font-weight: 600;
    }
    .badge-excellent { background: #d4edda; color: #155724; }
    .badge-good      { background: #cce5ff; color: #004085; }
    .badge-medium    { background: #fff3cd; color: #856404; }
    .badge-low       { background: #f8d7da; color: #721c24; }

    @media (max-width:768px) {
      .content-grid { grid-template-columns: 1fr; }
      .analysis-grid { grid-template-columns: 1fr; }
      .filters { flex-direction: column; align-items: stretch; }
      .header h1 { font-size: 2rem; }
    }

    .loading {
      display: inline-block; width: 20px; height: 20px;
      border: 3px solid rgba(102,126,234,0.3);
      border-radius: 50%; border-top-color: #667eea;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
{% endblock %}
{% block content %}
  <div class="dashboard-container">

    <!-- Header -->
    <div class="header">
      <h1><i class="fas fa-chart-line"></i> RMA Market Coverage Dashboard</h1>
      <p>Comprehensive market analysis and coverage optimization for RMA network expansion</p>
    </div>

    <!-- Filters -->
    <div class="filters">
      <div class="filter-group">
        <label for="province-filter">Province Filter</label>
        <input
          type="text"
          id="province-filter"
          placeholder="Filter by province…"
          value="{{ current_province_filter|default:'' }}"
        >
      </div>
      <div class="filter-group">
        <label for="potential-filter">Market Potential</label>
        <select id="potential-filter">
          <option value="">All Potentials</option>
          {% for potential in potential_choices %}
            <option
              value="{{ potential }}"
              {% if potential == current_potential_filter %}selected{% endif %}
            >{{ potential|capfirst }}</option>
          {% endfor %}
        </select>
      </div>
      <button type="button" onclick="applyFilters()">Apply Filters</button>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showTab(event,'overview')">
        <i class="fas fa-home"></i> Overview
      </button>
      <button class="nav-tab" onclick="showTab(event,'market-analysis')">
        <i class="fas fa-chart-bar"></i> Market Analysis
      </button>
      <button class="nav-tab" onclick="showTab(event,'performance')">
        <i class="fas fa-trophy"></i> RMA Performance
      </button>
      <button class="nav-tab" onclick="showTab(event,'risk-analysis')">
        <i class="fas fa-exclamation-triangle"></i> Risk Analysis
      </button>
    </div>

    <!-- Overview Tab -->
    <div id="overview" class="tab-content active">
      <!-- Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-map-marked-alt"></i></div>
          <div class="stat-value">{{ total_communes|floatformat:0 }}</div>
          <div class="stat-label">Total Communes</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-users"></i></div>
          <div class="stat-value">{{ total_population|floatformat:0 }}</div>
          <div class="stat-label">Total Population</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-car"></i></div>
          <div class="stat-value">{{ total_estimated_vehicles|floatformat:0 }}</div>
          <div class="stat-label">Estimated Vehicles</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-building"></i></div>
          <div class="stat-value">{{ total_rma_offices }}</div>
          <div class="stat-label">RMA Offices</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-crosshairs"></i></div>
          <div class="stat-value">{{ total_competitors }}</div>
          <div class="stat-label">Competitors</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-university"></i></div>
          <div class="stat-value">{{ total_banks }}</div>
          <div class="stat-label">Banks</div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="content-grid">
        <div class="chart-container">
          <h3 class="chart-title"><i class="fas fa-pie-chart"></i> Market Potential Distribution</h3>
          <canvas id="potentialChart" width="400" height="200"></canvas>
        </div>

        <div class="opportunities-list">
          <h3 class="chart-title"><i class="fas fa-star"></i> Top Opportunities</h3>
          {% for op in top_opportunities %}
            <div class="opportunity-item">
              <div>
                <div class="opportunity-name">{{ op.area.name }}</div>
                <div class="item-value">Pop: {{ op.area.population|floatformat:0 }}</div>
              </div>
              <div class="opportunity-score">{{ op.score|floatformat:1 }}</div>
            </div>
          {% endfor %}
        </div>
      </div>

      <!-- Analysis Grid -->
      <div class="analysis-grid">
        <div class="analysis-card">
          <h3 class="analysis-title"><i class="fas fa-bullseye"></i> Market Gaps</h3>
          {% for gap in market_gaps %}
            <div class="analysis-item">
              <div class="item-name">{{ gap.name }}</div>
              <div class="item-value">Pop: {{ gap.population|floatformat:0 }} | Comp: {{ gap.competition_count }}</div>
            </div>
          {% endfor %}
        </div>
        <div class="analysis-card">
          <h3 class="analysis-title"><i class="fas fa-fire"></i> High Competition Areas</h3>
          {% for area in high_competition_areas %}
            <div class="analysis-item">
              <div class="item-name">{{ area.name }}</div>
              <div class="item-value">Intensity: {{ area.competition_intensity|floatformat:1 }}/10k</div>
            </div>
          {% endfor %}
        </div>
        <div class="analysis-card">
          <h3 class="analysis-title"><i class="fas fa-exclamation-triangle"></i> Recent Loss Ratios</h3>
          {% for lr in recent_loss_ratios %}
            <div class="analysis-item">
              <div class="item-name">
                {{ lr.area.name|default:lr.commune.name|default:lr.province.name }}
              </div>
              <div class="item-value">
                <span class="badge
                  {% if lr.loss_ratio > 0.8 %}badge-low
                  {% elif lr.loss_ratio > 0.6 %}badge-medium
                  {% else %}badge-good
                  {% endif %}">
                  {{ lr.loss_ratio|floatformat:2 }}
                </span>
              </div>
            </div>
          {% endfor %}
        </div>
        <div class="analysis-card">
          <h3 class="analysis-title"><i class="fas fa-chart-line"></i> RMA Performance</h3>
          {% for perf in rma_performance %}
            <div class="analysis-item">
              <div class="item-name">{{ perf.type }}</div>
              <div class="item-value">Count: {{ perf.count }} | Avg CA: {{ perf.avg_ca|floatformat:0 }}</div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Market Analysis Tab -->
    <div id="market-analysis" class="tab-content">
      <div class="analysis-grid">
        <div class="analysis-card">
          <h3 class="analysis-title"><i class="fas fa-gem"></i> High Potential, Low Competition</h3>
          <div id="high-potential-content"><div class="loading"></div> Loading…</div>
        </div>
        <div class="analysis-card">
          <h3 class="analysis-title"><i class="fas fa-chart-area"></i> Market Penetration by Province</h3>
          {% for province in provinces_data %}
            <div class="analysis-item">
              <div class="item-name">{{ province.name }}</div>
              <div class="item-value">
                Pop: {{ province.population|floatformat:0 }} |
                RMA: {{ province.rma_offices }} |
                Score: {{ province.avg_score|floatformat:1 }}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
      <div class="chart-container">
        <h3 class="chart-title"><i class="fas fa-map"></i> Geographic Distribution Analysis</h3>
        <canvas id="geographicChart" width="400" height="300"></canvas>
      </div>
    </div>

    <!-- Performance Tab -->
    <div id="performance" class="tab-content">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-building"></i></div>
          <div class="stat-value">{{ rma_performance.0.count|default:0 }}</div>
          <div class="stat-label">BGD Offices</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-user-tie"></i></div>
          <div class="stat-value">{{ rma_performance.1.count|default:0 }}</div>
          <div class="stat-label">Agent Offices</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
          <div class="stat-value">{{ rma_performance.0.avg_ca|default:0|floatformat:0 }}</div>
          <div class="stat-label">Avg BGD CA</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
          <div class="stat-value">{{ rma_performance.1.avg_ca|default:0|floatformat:0 }}</div>
          <div class="stat-label">Avg Agent CA</div>
        </div>
      </div>
      <div class="chart-container">
        <h3 class="chart-title"><i class="fas fa-trophy"></i> Performance Comparison</h3>
        <canvas id="performanceChart" width="400" height="300"></canvas>
      </div>
    </div>

    <!-- Risk Analysis Tab -->
    <div id="risk-analysis" class="tab-content">
      <div class="analysis-grid">
        <div class="analysis-card">
          <h3 class="analysis-title"><i class="fas fa-exclamation-triangle"></i> High Risk Areas</h3>
          {% for risk in high_risk_areas %}
            <div class="analysis-item">
              <div class="item-name">
                {{ risk.area.name|default:risk.commune.name|default:risk.province.name }}
              </div>
              <div class="item-value">
                <span class="badge badge-low">{{ risk.loss_ratio|floatformat:2 }}</span>
              </div>
            </div>
          {% endfor %}
        </div>
        <div class="analysis-card">
          <h3 class="analysis-title"><i class="fas fa-shield-alt"></i> Risk Mitigation Strategies</h3>
          <div class="analysis-item"><div class="item-name">Enhanced Underwriting</div><div class="item-value">For areas with LR &gt; 0.8</div></div>
          <div class="analysis-item"><div class="item-name">Market Diversification</div><div class="item-value">Expand to lower-risk areas</div></div>
          <div class="analysis-item"><div class="item-name">Premium Adjustment</div><div class="item-value">Review pricing in high-risk zones</div></div>
        </div>
      </div>
      <div class="chart-container">
        <h3 class="chart-title"><i class="fas fa-chart-line"></i> Loss Ratio Trends</h3>
        <canvas id="lossRatioChart" width="400" height="300"></canvas>
      </div>
    </div>

  </div>
  {% endblock %}
  {% block scripts %}
  {# Embed JSON safely #}
    {{ coverage_chart_data      |json_script:"coverage-data" }}
    {{ provinces_data_json      |json_script:"provinces-data" }}
    {{ recent_loss_ratios_json  |json_script:"loss-ratios-data" }}
    {{ rma_performance_json     |json_script:"performance-data" }}


  <script>
    // Tab switching
    function showTab(evt, tabId) {
      document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(nt => nt.classList.remove('active'));

      document.getElementById(tabId).classList.add('active');
      evt.currentTarget.classList.add('active');

      if (tabId === 'market-analysis') loadMarketAnalysis();
      if (tabId === 'performance')    loadPerformanceData();
    }

    // Apply URL filters
    function applyFilters() {
      const province = document.getElementById('province-filter').value;
      const potential = document.getElementById('potential-filter').value;
      const params = new URLSearchParams(window.location.search);
      province ? params.set('province', province) : params.delete('province');
      potential ? params.set('potential', potential) : params.delete('potential');
      window.location.search = params.toString();
    }

    // Parse Django context JSON
    const coverageData     = JSON.parse(document.getElementById('coverage-data').textContent);
    const provincesData    = JSON.parse(document.getElementById('provinces-data').textContent);
    const recentLossRatios = JSON.parse(document.getElementById('loss-ratios-data').textContent);
    const performanceData  = JSON.parse(document.getElementById('performance-data').textContent);



    // Initialize all charts
    function initCharts() {
      // 1. Potential Distribution
      new Chart(document.getElementById('potentialChart').getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: coverageData.map(x => x.potential),
          datasets: [{
            data: coverageData.map(x => x.count),
            backgroundColor: ['rgba(102,126,234,0.8)','rgba(118,75,162,0.8)','rgba(255,193,7,0.8)','rgba(220,53,69,0.8)'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position:'bottom', labels:{padding:20,usePointStyle:true} } }
        }
      });

      // 2. Geographic Distribution (first 10)
      const geoSlice = provincesData.slice(0,10);
      new Chart(document.getElementById('geographicChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels: geoSlice.map(p=>p.name),
          datasets: [
            { label:'Population', data: geoSlice.map(p=>p.population), backgroundColor:'rgba(102,126,234,0.6)', borderWidth:1 },
            { label:'RMA Offices', data: geoSlice.map(p=>p.rma_offices), backgroundColor:'rgba(118,75,162,0.6)', borderWidth:1, yAxisID:'y1' }
          ]
        },
        options: {
          responsive:true,
          scales:{ y:{beginAtZero:true}, y1:{type:'linear',position:'right',beginAtZero:true,grid:{drawOnChartArea:false}} }
        }
      });

      // 3. Performance Comparison
      new Chart(document.getElementById('performanceChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels: ['BGD Offices','Agent Offices'],
          datasets:[{
            label:'Average CA',
            data:[performanceData[0]?.avg_ca||0, performanceData[1]?.avg_ca||0],
            backgroundColor:['rgba(102,126,234,0.8)','rgba(118,75,162,0.8)'], borderWidth:0
          }]
        },
        options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });

      // 4. Loss Ratio Trends
      const lrSlice = [...recentLossRatios].reverse();
      new Chart(document.getElementById('lossRatioChart').getContext('2d'), {
        type: 'line',
        data: {
          labels: lrSlice.map(lr=> lr.area?.name||lr.commune?.name||lr.province?.name),
          datasets:[{
            label:'Loss Ratio',
            data: lrSlice.map(lr=>lr.loss_ratio),
            borderColor:'rgba(220,53,69,1)',
            backgroundColor:'rgba(220,53,69,0.1)',
            borderWidth:2, fill:true, tension:0.4
          }]
        },
        options:{ responsive:true, scales:{y:{beginAtZero:true, max:1.2}} }
      });
    }

    // Simulate AJAX load for market-analysis
    function loadMarketAnalysis() {
      const cont = document.getElementById('high-potential-content');
      if (cont.innerHTML.includes('Loading')) {
        setTimeout(() => {
          cont.innerHTML = `
            <div class="analysis-item"><div class="item-name">Casablanca Periphery</div><div class="item-value">Pop: 45,000 | Comp: 1</div></div>
            <div class="analysis-item"><div class="item-name">Marrakech North</div><div class="item-value">Pop: 32,000 | Comp: 0</div></div>
            <div class="analysis-item"><div class="item-name">Fes Industrial Zone</div><div class="item-value">Pop: 28,000 | Comp: 1</div></div>
          `;
        }, 1000);
      }
    }
    function loadPerformanceData() {
      console.log('Performance data loaded');
    }

    document.addEventListener('DOMContentLoaded', () => {
      initCharts();
      document.getElementById('province-filter')
        .addEventListener('keypress', e => { if (e.key==='Enter') applyFilters(); });
    });
  </script>
{% endblock %}